name: Dependency Update Check

on:
    schedule:
        - cron: "0 0 * * 1" # Weekly on Monday
    workflow_dispatch:

jobs:
    update-dependencies:
        name: Check and Update Dependencies
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  java-version: "21"
                  distribution: "temurin"
                  cache: "maven"

            - name: Check for dependency updates
              run: |
                  mvn versions:display-dependency-updates > dependency-updates.txt
                  mvn versions:display-plugin-updates >> dependency-updates.txt

            - name: Update dependencies
              run: |
                  mvn versions:use-latest-releases -DallowMajorUpdates=false
                  mvn versions:update-properties -DallowMajorUpdates=false

            - name: Build and test with updated dependencies
              run: |
                  cd shared-domain && mvn clean install -DskipTests
                  mvn clean test
              continue-on-error: true

            - name: Create Pull Request
              uses: peter-evans/create-pull-request@v5
              with:
                  token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
                  commit-message: "chore: update dependencies"
                  title: "chore: Automated dependency updates"
                  body: |
                      ## 🔄 Automated Dependency Updates

                      This PR contains automated dependency updates.

                      ### 📦 Updated Dependencies
                      See the changes in `pom.xml` files.

                      ### ✅ Verification
                      - All tests have been run with updated dependencies
                      - Review the changes before merging

                      ### 🔍 Security
                      Run security scans before merging this PR.
                  branch: dependency-updates
                  delete-branch: true
                  labels: dependencies, automated

            - name: Upload dependency report
              uses: actions/upload-artifact@v4
              with:
                  name: dependency-updates-report
                  path: dependency-updates.txt
                  retention-days: 30
